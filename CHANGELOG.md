# 收益分配测算系统 - 更新日志

## [2.5.2] - 2024-12-19

### 🐛 重要Bug修复
- **彻底解决第二次导入计算错误**: 修复了第二次重新导入数据计算时出现"invalid digits value: NaN"错误的根本问题
  - **问题根源**: 后端使用全局calculator实例导致状态污染，第一次计算后的残留数据影响第二次计算
  - **解决方案**: 
    - 新增`/api/reset` API端点，提供后端状态重置功能
    - 增强前端`resetAllData()`函数，同步调用后端重置API
    - 强化`importExcel()`函数，导入前自动重置系统状态
    - 全面增强数据验证，防止NaN值进入计算流程

### ✨ 功能增强
- **新增后端状态重置功能**: 
  - 提供独立的重置API，确保前后端状态完全同步
  - 增强数据验证机制，对所有数值类型进行NaN/Inf检查
  - 改进错误处理和日志记录

- **优化Excel导入流程**:
  - 导入前自动重置系统状态，确保干净的开始
  - 增强数据清理和类型转换逻辑
  - 改进异常处理，提供更详细的错误信息

### 🔧 技术改进
- **后端API增强**:
  - 新增 `POST /api/reset` - 重置计算器状态
  - 改进 `POST /api/basic-params` - 增强数据验证
  - 改进 `POST /api/cash-flows` - 增强数据清理
  - 增强异常处理和错误消息

- **前端状态管理优化**:
  - 重构数据重置逻辑，支持前后端同步重置
  - 新增`resetAllDataSilently()`函数，支持静默重置
  - 改进`importExcel()`流程，确保数据导入的可靠性

### 📋 测试验证
- ✅ 第一次计算正常
- ✅ 第二次重新导入数据计算正常
- ✅ 多次连续计算均正常
- ✅ 重置按钮功能正常
- ✅ Excel导入导出功能正常

---

## [2.5.1] - 2024-12-19

### 🎨 界面优化
- **表格列顺序调整**: 在"结构化-息息本本"模式的计算详情表格中，调整了"劣后级期初本金"和"优先级期间收益"两列的顺序
  - 优先级期间收益移至第5列（原第6列）
  - 劣后级期初本金移至第6列（原第5列）
  - 同步调整了表头、数据行和总计行的显示顺序
  - 使相关数据列在逻辑上更加紧密，提升用户阅读体验

### 📋 技术细节
- 优化了displayResults函数中结构化-息息本本模式的表格渲染逻辑
- 确保表头定义、数据行显示和总计行计算的一致性
- 保持其他计算模式的表格布局不变

---

## [2.5.0] - 2024-12-19

### 🚀 新功能增强
#### 核心指标扩展
- ✅ **新增静态回本周期计算**：计算投资项目的简单回本时间
- ✅ **新增动态回本周期计算**：考虑时间价值的折现回本时间（使用门槛收益率作为折现率）
- ✅ **完善IRR和DPI指标展示**：提供更全面的投资收益分析

#### 用户界面优化
- ✅ **投资收益分析区域重设计**：
  - 统一的指标卡片展示（IRR、DPI、静态回本周期、动态回本周期）
  - 专业的项目信息网格布局
  - 现代化的渐变色彩和视觉效果
- ✅ **表格汇总功能强化**：
  - 在详细计算表格底部新增总计行
  - 正确计算分派率（总净现金流/总投资金额）
  - 智能区分可求和与不可求和的数据列
  - 优雅的紫色渐变总计行样式

### 🐛 问题修复
#### 交互体验修复
- ✅ **修复Excel导入后状态显示**：导入文件后不再显示"正在计算中"的误导提示
- ✅ **修复页面初始化问题**：解决进入系统后持续显示加载状态的问题
- ✅ **完善加载遮罩管理**：区分页面加载遮罩和计算加载遮罩，确保状态切换正确

#### 数据计算优化
- ✅ **完善结构化模式总计计算**：所有5种计算模式的数值列都能正确累计
- ✅ **优化回本周期计算逻辑**：处理无法回本的边界情况，返回"无法回本"标识
- ✅ **增强数据精度控制**：后端保持高精度计算，前端优化显示格式

### 🎨 界面美化
#### 视觉风格统一
- ✅ **计算结果页面重新设计**：
  - 现代化卡片布局和阴影效果
  - 统一的色彩方案和字体规范
  - 响应式网格系统适配不同屏幕
- ✅ **表格样式优化**：
  - 专业的表头渐变背景
  - 悬停交互动画效果
  - 正值数据的绿色高亮显示
  - 年份列的特殊标识样式

#### 用户体验提升
- ✅ **指标卡片交互效果**：鼠标悬停时的动态变换
- ✅ **数据格式优化**：货币金额千分位分隔符，百分比精确显示
- ✅ **颜色语义化设计**：不同类型数据采用不同的色彩编码

### 📊 计算模式完善
#### 支持的分配模式
1. **平层结构**
   - 优先还本模式：增强总计计算和显示
   - 期间分配模式：完善数据汇总逻辑

2. **结构化模式**
   - 优先劣后模式：优化本金余额显示
   - 包含夹层模式：完善三层结构的总计计算
   - 息息本本模式：强化期间收益的汇总展示

### 🔧 技术改进
#### 前端架构优化
- ✅ **加载状态管理重构**：分离页面初始化和功能操作的加载状态
- ✅ **CSS架构优化**：模块化样式定义，提高可维护性
- ✅ **JavaScript逻辑完善**：增强错误处理和状态管理

#### 后端计算引擎
- ✅ **新增回本周期计算方法**：支持静态和动态两种计算方式
- ✅ **完善数据验证逻辑**：增强边界情况处理
- ✅ **优化计算精度控制**：确保数值计算的准确性

---

## 系统兼容性
- ✅ **浏览器支持**：Chrome 90+, Firefox 90+, Safari 14+, Edge 90+
- ✅ **Excel兼容**：支持.xlsx和.xls格式文件导入导出
- ✅ **响应式设计**：适配桌面端、平板和移动设备

## 下一版本预告
- 📈 图表可视化功能增强
- 📊 多方案对比分析
- 💾 数据本地缓存功能
- 🔄 批量计算支持

---

*如有问题或建议，欢迎通过GitHub Issues反馈* 