# 收益分配测算系统

![Python](https://img.shields.io/badge/Python-3.8%2B-blue)
![Flask](https://img.shields.io/badge/Flask-2.3.3-green)
![License](https://img.shields.io/badge/License-MIT-orange)
[![GitHub](https://img.shields.io/badge/GitHub-JMoCoder-black?logo=github)](https://github.com/JMoCoder/calculation_of_fund_returns)

📂 **项目地址**: [https://github.com/JMoCoder/calculation_of_fund_returns](https://github.com/JMoCoder/calculation_of_fund_returns)

## 📖 项目简介

收益分配测算系统是一个专业的金融计算工具，用于基于资产的未来净现金流预测，快速计算不同分配模式下的投资收益结果。系统支持多种收益分配模式，提供直观的数据展示和Excel导出功能。

## ✨ 主要功能

### 💼 投资参数设置
- **基本参数输入**：投资标的、投资金额、投资期限、门槛收益率、管理人Carry
- **净现金流输入**：支持逐年输入或Excel批量导入
- **参数验证**：实时数据验证，确保输入的合理性

### 📊 分配模式计算

#### 🏗️ 平层结构
1. **优先还本模式**
   - 净现金流优先还本，并按期初本金余额计提门槛收益
   - 本金还完当期，开始分配已计提的门槛收益
   - 门槛收益还完当期，剩余净现金流开始分配Carry

2. **期间分配模式**
   - 净现金流优先按照期初本金余额分配期间收益
   - 分配期间收益后，剩余现金流归还本金，并按期初本金余额计提门槛收益
   - 本金还完当期，开始分配已计提的剩余门槛收益

#### 🏢 结构化分配
1. **优先劣后模式**
   - 当期净现金流优先按期初优先级剩余本金×优先级收益率分配给优先级
   - 剩余净现金流偿还优先级本金
   - 优先级退出后，剩余净现金流开始偿还劣后本金
   - 劣后本金退出后，剩余净现金流开始分配Carry

### 📈 核心指标计算
- **IRR（内部收益率）**：使用牛顿法精确计算
- **DPI（分配倍数）**：总分配金额与初始投资的比值
- **现金流分配表**：详细的年度现金流分配明细

### 📤 数据导入导出
- **Excel模板下载**：标准化的数据输入模板
- **Excel文件导入**：批量导入基本参数和现金流数据
- **结果导出**：将计算结果导出为Excel文件，包含基本信息和详细分配表

## 🚀 一键部署

### Windows环境

#### 首次部署（推荐新用户）

1. **下载项目文件**到本地目录
2. **双击运行** `deploy.bat` 脚本
3. **等待自动部署**完成
4. **浏览器自动打开**系统页面

部署脚本将自动完成以下操作：
- ✅ 检查Python环境
- ✅ 验证pip包管理器
- ✅ 升级pip到最新版本
- ✅ 安装所有依赖包
- ✅ 检查端口占用情况
- ✅ 启动Web服务器
- ✅ 打开默认浏览器

#### 日常启动（已配置环境）

如果您已经成功运行过 `deploy.bat`，后续使用可以直接：

1. **双击运行** `start.bat` 脚本
2. **系统快速启动**（跳过环境检查和依赖安装）
3. **浏览器自动打开**系统页面

**使用建议**：
- 🆕 **首次使用**：使用 `deploy.bat` 进行完整环境配置
- ⚡ **日常使用**：使用 `start.bat` 快速启动，节省时间
- 🔄 **环境问题**：如遇到依赖错误，重新运行 `deploy.bat`

### 手动部署

如果一键部署遇到问题，可以手动执行以下步骤：

```bash
# 1. 检查Python版本（需要3.8+）
python --version

# 2. 安装依赖包
pip install -r requirements.txt

# 3. 启动应用
python app.py

# 4. 打开浏览器访问
# http://localhost:5000
```

## 📋 系统要求

### 最低配置
- **操作系统**：Windows 10/11，macOS 10.14+，Linux
- **Python版本**：3.8或更高版本
- **内存**：2GB RAM
- **存储空间**：500MB可用空间
- **网络**：安装时需要网络连接（用于下载依赖包）

### 推荐配置
- **操作系统**：Windows 11，macOS 12+，Ubuntu 20.04+
- **Python版本**：3.10或更高版本
- **内存**：4GB RAM或更多
- **存储空间**：1GB可用空间

## 🎯 使用指南

### 第一步：设置基本参数
1. 输入投资标的名称
2. 设置拟投资金额（万元）
3. 确定投资期限（1-30年）
4. 设置门槛收益率（%）
5. 设置管理人Carry（%）

### 第二步：输入净现金流
1. 系统根据投资期限自动生成输入框
2. 逐年输入各期的净现金流（万元）
3. 或者点击"导入Excel"批量导入数据

### 第三步：选择分配模式
1. **平层结构**
   - 选择"优先还本"或"期间分配"
   - 如选择期间分配，需输入期间收益率

2. **结构化**
   - 选择"优先劣后"模式
   - 设置优先级比例（%）
   - 系统自动计算优先级和劣后级金额

### 第四步：执行计算
1. 点击"开始计算"按钮
2. 系统显示计算进度
3. 查看IRR和DPI核心指标
4. 查看详细的现金流分配表

### 第五步：导出结果
1. 点击"导出Excel"按钮
2. 系统生成包含基本信息和分配表的Excel文件
3. 文件自动下载到本地

## 🔒 数据安全

本系统采用以下安全措施确保数据安全：

- **无持久化存储**：所有计算数据仅在内存中处理，会话结束后自动清理
- **本地部署**：系统运行在用户本地环境，数据不上传到外部服务器
- **数据验证**：对所有输入数据进行严格验证，防止恶意输入
- **临时文件清理**：系统自动清理计算过程中产生的临时文件

## 🛠️ 技术架构

### 后端技术栈
- **Python 3.8+**：主要编程语言
- **Flask 2.3.3**：Web框架
- **Pandas 2.1.1**：数据处理
- **NumPy 1.24.3**：数值计算
- **OpenPyXL 3.1.2**：Excel文件处理

### 前端技术栈
- **HTML5 + CSS3**：页面结构和样式
- **Bootstrap 5.3**：UI框架
- **JavaScript ES6+**：交互逻辑
- **Chart.js**：图表展示
- **Font Awesome**：图标库

### 核心计算算法
- **IRR计算**：牛顿法迭代求解
- **现金流分配**：基于业务规则的逐期计算
- **数据验证**：多层次输入验证机制

## 📚 计算逻辑说明

### 平层结构 - 优先还本
```
每期分配顺序：
1. 计提门槛收益 = 期初本金余额 × 门槛收益率
2. 摊还本金 = min(净现金流, 剩余本金)
3. 分配门槛收益 = min(剩余现金流, 累计门槛收益)
4. Carry分配 = 剩余现金流 × (1-管理人Carry, 管理人Carry)
```

### 平层结构 - 期间分配
```
每期分配顺序：
1. 期间收益 = min(净现金流, 期初本金余额 × 期间收益率)
2. 计提门槛收益 = 期初本金余额 × (门槛收益率 - 期间收益率)
3. 摊还本金 = min(剩余现金流, 剩余本金)
4. 分配门槛收益 = min(剩余现金流, 累计门槛收益)
5. Carry分配 = 剩余现金流 × (1-管理人Carry, 管理人Carry)
```

### 结构化 - 优先劣后
```
每期分配顺序：
1. 优先级收益 = min(净现金流, 优先级剩余本金 × 优先级收益率)
2. 优先级本金 = min(剩余现金流, 优先级剩余本金)
3. 劣后级本金 = min(剩余现金流, 劣后级剩余本金)
4. Carry分配 = 剩余现金流 × (1-管理人Carry, 管理人Carry)
```

## ❓ 常见问题

### Q: 首次使用应该运行哪个脚本？
A: 首次使用请运行 `deploy.bat`，它会自动检查和配置完整的运行环境。

### Q: 什么时候使用 start.bat？
A: 在已经成功运行过 `deploy.bat` 后，日常使用可以直接运行 `start.bat` 快速启动，它会跳过环境检查和依赖安装步骤。

### Q: 如果 start.bat 启动失败怎么办？
A: 如果快速启动失败，说明环境可能有问题，请重新运行 `deploy.bat` 来修复环境配置。

### Q: 系统支持的最大投资期限是多少？
A: 系统支持1-30年的投资期限，覆盖大部分实际投资场景。

### Q: 可以同时计算多个项目吗？
A: 当前版本为单项目计算模式，如需计算多个项目请分别运行。

### Q: 数据会被保存在哪里？
A: 系统不会永久保存任何数据，所有计算数据仅在会话期间存在于内存中。

### Q: 如何修改已输入的数据？
A: 可以通过步骤导航返回到相应步骤重新输入数据。

### Q: Excel导入支持哪些格式？
A: 支持.xlsx和.xls格式的Excel文件。

## 📞 技术支持

如果在使用过程中遇到问题，请检查以下事项：

1. **Python版本**：确保Python版本为3.8或更高
2. **依赖安装**：确认所有依赖包已正确安装
3. **端口占用**：确保5000端口未被其他程序占用
4. **网络连接**：首次安装时需要网络连接下载依赖

### 🐛 问题反馈

如果遇到Bug或有功能建议，欢迎通过以下方式反馈：

- **GitHub Issues**: [https://github.com/JMoCoder/calculation_of_fund_returns/issues](https://github.com/JMoCoder/calculation_of_fund_returns/issues)
- **项目仓库**: [https://github.com/JMoCoder/calculation_of_fund_returns](https://github.com/JMoCoder/calculation_of_fund_returns)

### 📥 获取最新版本

```bash
# 克隆项目到本地
git clone https://github.com/JMoCoder/calculation_of_fund_returns.git

# 进入项目目录
cd calculation_of_fund_returns

# 运行一键部署
deploy.bat
```

## 📄 许可证

本项目采用MIT许可证，详情请查看LICENSE文件。

## 🙏 致谢

感谢所有为本项目提供支持和建议的用户和开发者。

### 👨‍💻 开发者

- **JMoCoder** - 项目维护者
  - GitHub: [@JMoCoder](https://github.com/JMoCoder)
  - Email: jiamo.im@gmail.com

### 🤝 贡献

欢迎提交Pull Request来改进项目！请遵循以下步骤：

1. Fork本项目
2. 创建功能分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 打开Pull Request

---

**收益分配测算系统** - 专业、安全、易用的投资收益计算工具 

⭐ 如果这个项目对您有帮助，请给个Star支持一下！ 