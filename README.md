# 收益分配测算系统

![Python](https://img.shields.io/badge/Python-3.8%2B-blue)
![Flask](https://img.shields.io/badge/Flask-2.3.3-green)
![License](https://img.shields.io/badge/License-MIT-orange)
![Version](https://img.shields.io/badge/Version-v3.2.0-brightgreen)
[![GitHub](https://img.shields.io/badge/GitHub-JMoCoder-black?logo=github)](https://github.com/JMoCoder/calculation_of_fund_returns)

📂 **项目地址**: [https://github.com/JMoCoder/calculation_of_fund_returns](https://github.com/JMoCoder/calculation_of_fund_returns)

## 📖 项目简介

收益分配测算系统是一个专业的金融计算工具，用于基于资产的未来净现金流预测，快速计算不同分配模式下的投资收益结果。系统支持多种收益分配模式，提供直观的数据展示和Excel导出功能。

**🎯 v3.2.0 重要更新**: 在v3.1.0标准化架构基础上，全新升级了图表可视化功能，新增图表放大展示和一键复制PNG功能，大幅提升数据分析和分享体验。

## 🗂️ 项目结构 (v3.1.0)

### 📁 标准化目录结构
```
calculation_of_fund_returns/
├── 📄 app.py                    # 主应用程序 (Flask后端 + 核心计算逻辑)
├── 🚀 run_tests.py             # 统一测试运行器 (支持多种测试模式)
├── 📁 tests/                   # 标准化测试目录
│   ├── __init__.py             # 测试包初始化
│   ├── test_api.py             # API接口测试
│   ├── test_calculations.py    # 核心计算逻辑测试
│   └── test_charts.py          # 综合图表功能测试
├── 📁 templates/               # HTML模板文件
│   └── index.html              # 主页面模板
├── 📁 static/                  # 静态资源文件
│   ├── css/                    # 样式文件
│   ├── js/                     # JavaScript文件
│   └── images/                 # 图片资源
├── 📋 requirements.txt         # Python依赖包定义
├── 🚀 deploy.bat              # Windows一键部署脚本
├── ⚡ start.bat               # Windows快速启动脚本
├── 📚 CHANGELOG.md            # 详细更新日志
└── 📖 README.md               # 项目说明文档
```

### 🧪 测试系统架构
- **统一入口**: `run_tests.py` 提供灵活的测试执行方式
- **模块化测试**: 按功能分离的测试文件，便于维护和扩展
- **全面覆盖**: API接口、计算逻辑、图表功能的完整测试覆盖

## ✨ 主要功能

### 💼 投资参数设置
- **基本参数输入**：投资标的、投资金额、投资期限、门槛收益率、管理人Carry
- **净现金流输入**：支持逐年输入或Excel批量导入
- **参数验证**：实时数据验证，确保输入的合理性

### 📊 分配模式计算

#### 🏗️ 平层结构
1. **优先还本模式**
   - 净现金流优先还本，并按期初本金余额计提门槛收益
   - 本金还完当期，开始分配已计提的门槛收益
   - 门槛收益还完当期，剩余净现金流开始分配Carry

2. **期间分配模式**
   - 净现金流优先按照期初本金余额分配期间收益
   - 分配期间收益后，剩余现金流归还本金，并按期初本金余额计提门槛收益
   - 本金还完当期，开始分配已计提的剩余门槛收益

#### 🏢 结构化分配
1. **优先劣后模式**
   - 当期净现金流优先按期初优先级剩余本金×优先级收益率分配给优先级
   - 剩余净现金流偿还优先级本金
   - 优先级退出后，剩余净现金流开始偿还劣后本金
   - 劣后本金退出后，剩余净现金流开始分配Carry

2. **包含夹层模式**
   - 三层结构期间收益分配
   - 分级本金归还机制
   - Carry费用合理分配

3. **息息本本模式**
   - 分层期间收益优先分配
   - 层级化本金归还逻辑
   - 完善的收益跟踪机制

### 📈 核心指标计算
- **IRR（内部收益率）**：使用牛顿法精确计算
- **DPI（分配倍数）**：总分配金额与初始投资的比值
- **静态回本周期**：简单累计现金流回本时间分析
- **动态回本周期**：考虑时间价值的折现回本周期计算
- **现金流分配表**：详细的年度现金流分配明细

### 📤 数据导入导出
- **Excel模板下载**：标准化的数据输入模板
- **Excel文件导入**：批量导入基本参数和现金流数据
- **结果导出**：将计算结果导出为Excel文件，包含基本信息和详细分配表

### 📊 图表功能增强 (v3.2.0新增)

#### 🔍 图表放大展示功能
- **功能按钮**: 每个图表卡片右上角的放大图标 (`fa-expand-alt`)
- **全屏模态**: 点击后在全屏模态框中显示高清大图
- **响应式设计**: 自适应不同屏幕尺寸，支持移动端
- **交互控制**: 
  - 支持ESC键快速关闭
  - 支持点击外部区域关闭
  - 字体和元素自动优化以适应大屏显示
  - 保持原图表的所有交互功能

#### 📋 一键复制PNG功能
- **功能按钮**: 每个图表卡片右上角的复制图标 (`fa-copy`)
- **高清输出**: 3倍分辨率（3600x2400像素）确保图片清晰度
- **智能背景**: 自动添加纯白色背景，适合各种文档使用
- **剪切板集成**: 
  - 现代浏览器：直接复制到剪切板
  - 兼容模式：不支持剪切板时自动下载文件
- **样式一致性**: 采用"隐形放大展示"技术，确保复制的图表与放大展示100%一致

#### 🎯 技术亮点
- **样式统一**: 复制功能直接使用放大展示的渲染结果，确保视觉完全一致
- **性能优化**: 异步处理，不阻塞用户界面
- **内存管理**: 自动清理临时图表实例，防止内存泄漏
- **错误处理**: 完善的异常处理和用户友好的提示信息
- **浏览器兼容**: 
  - 放大展示：所有现代浏览器完全支持
  - 复制PNG：Chrome 76+, Firefox 127+, Safari 13.1+完全支持
  - 降级支持：IE等老旧浏览器自动降级为下载功能

#### 📱 用户体验优化
- **视觉设计**: 半透明按钮设计，悬停高亮效果
- **交互反馈**: 鼠标悬停tooltip提示，操作成功/失败明确反馈
- **键盘支持**: ESC快捷键关闭模态框
- **移动友好**: 触摸设备完美支持，响应式设计

#### 🔒 安全考虑
- **权限控制**: 仅在用户主动操作时请求剪切板权限
- **数据隐私**: 所有图表处理均在客户端完成，不上传服务器
- **XSS防护**: 用户输入经过适当转义处理
- **CSP兼容**: 实现符合内容安全策略要求

#### 💼 支持的图表类型
- **现金流回收分析**: 显示各期本金回收情况
- **现金流分配结构**: 展示收益分配的详细构成
- **剩余本金分析**: 跟踪投资本金的剩余变化
- **累计现金流分析**: 展示累计收益和现金流趋势
- **整体分配结构**: 饼图展示总体分配比例

## 🧪 测试系统 (v3.1.0新增)

### 🚀 智能测试运行器
```bash
# 运行所有测试
python run_tests.py

# 运行指定类型测试
python run_tests.py --api              # API接口测试
python run_tests.py --calculations     # 计算逻辑测试
python run_tests.py --charts          # 图表功能测试

# 快速测试模式
python run_tests.py --quick

# 跳过服务器检查
python run_tests.py --no-server-check
```

### 📋 测试覆盖内容
- **API接口测试**: 验证所有REST API端点的正确性和稳定性
- **计算逻辑测试**: 验证5种分配模式的计算准确性和业务逻辑
- **图表功能测试**: 验证数据可视化功能的完整性和配置正确性
- **边界场景测试**: 验证异常情况和边界条件的处理能力

### 🎯 测试特性
- **自动化测试**: 支持CI/CD集成的标准化测试流程
- **智能环境检查**: 自动检测服务器状态，提供友好提示
- **详细测试报告**: 提供测试耗时、成功率等统计信息
- **模块化测试**: 不同功能分离测试，便于问题定位

## 🚀 一键部署

### Windows环境

#### 首次部署（推荐新用户）

1. **下载项目文件**到本地目录
2. **双击运行** `deploy.bat` 脚本
3. **等待自动部署**完成
4. **浏览器自动打开**系统页面

部署脚本将自动完成以下操作：
- ✅ 检查Python环境
- ✅ 验证pip包管理器
- ✅ 升级pip到最新版本
- ✅ 安装所有依赖包
- ✅ 检查端口占用情况
- ✅ 启动Web服务器
- ✅ 打开默认浏览器

#### 日常启动（已配置环境）

如果您已经成功运行过 `deploy.bat`，后续使用可以直接：

1. **双击运行** `start.bat` 脚本
2. **系统快速启动**（跳过环境检查和依赖安装）
3. **浏览器自动打开**系统页面

**使用建议**：
- 🆕 **首次使用**：使用 `deploy.bat` 进行完整环境配置
- ⚡ **日常使用**：使用 `start.bat` 快速启动，节省时间
- 🔄 **环境问题**：如遇到依赖错误，重新运行 `deploy.bat`
- 🧪 **功能验证**：使用 `python run_tests.py` 运行完整测试

### 手动部署

如果一键部署遇到问题，可以手动执行以下步骤：

```bash
# 1. 检查Python版本（需要3.8+）
python --version

# 2. 安装依赖包
pip install -r requirements.txt

# 3. 启动应用
python app.py

# 4. 运行测试验证（可选）
python run_tests.py

# 5. 打开浏览器访问
# http://localhost:5000
```

## 📋 系统要求

### 最低配置
- **操作系统**：Windows 10/11，macOS 10.14+，Linux
- **Python版本**：3.8或更高版本
- **内存**：2GB RAM
- **存储空间**：500MB可用空间
- **网络**：安装时需要网络连接（用于下载依赖包）

### 推荐配置
- **操作系统**：Windows 11，macOS 12+，Ubuntu 20.04+
- **Python版本**：3.10或更高版本
- **内存**：4GB RAM或更多
- **存储空间**：1GB可用空间

## 🎯 使用指南

### 第一步：设置基本参数
1. 输入投资标的名称
2. 设置拟投资金额（万元）
3. 确定投资期限（1-30年）
4. 设置门槛收益率（%）
5. 设置管理人Carry（%）

### 第二步：输入净现金流
1. 系统根据投资期限自动生成输入框
2. 逐年输入各期的净现金流（万元）
3. 或者点击"导入Excel"批量导入数据

### 第三步：选择分配模式
1. **平层结构**
   - 选择"优先还本"或"期间分配"
   - 如选择期间分配，需输入期间收益率

2. **结构化**
   - 选择具体的结构化模式（优先劣后、包含夹层、息息本本）
   - 根据选择的模式设置相应参数
   - 系统自动计算分级金额和比例

### 第四步：执行计算
1. 点击"开始计算"按钮
2. 系统显示计算进度
3. 查看IRR、DPI、回本周期等核心指标
4. 查看详细的现金流分配表

### 第五步：导出结果
1. 点击"导出Excel"按钮
2. 系统生成包含基本信息和分配表的Excel文件
3. 文件自动下载到本地

### 🧪 第六步：功能验证（可选）
1. 运行 `python run_tests.py` 进行系统功能验证
2. 查看测试报告确保系统运行正常
3. 针对特定功能运行专项测试

## 🔒 数据安全

本系统采用以下安全措施确保数据安全：

- **无持久化存储**：所有计算数据仅在内存中处理，会话结束后自动清理
- **本地部署**：系统运行在用户本地环境，数据不上传到外部服务器
- **数据验证**：对所有输入数据进行严格验证，防止恶意输入
- **临时文件清理**：系统自动清理计算过程中产生的临时文件
- **测试数据隔离**：测试系统使用独立的数据环境，不影响生产数据

## 🛠️ 技术架构

### 后端技术栈
- **Python 3.8+**：主要编程语言
- **Flask 2.3.3**：Web框架，提供RESTful API
- **Pandas 2.1.1**：数据处理和分析
- **NumPy 1.24.3**：高性能数值计算
- **OpenPyXL 3.1.2**：Excel文件读写处理

### 前端技术栈
- **HTML5 + CSS3**：现代化页面结构和样式
- **Bootstrap 5.3**：响应式UI框架
- **JavaScript ES6+**：现代化交互逻辑
- **Chart.js**：专业图表展示库
- **Font Awesome**：矢量图标库

### 测试技术栈 (v3.1.0新增)
- **Python unittest**：标准单元测试框架
- **requests**：HTTP请求测试库
- **自定义测试套件**：专门的金融计算测试工具
- **测试运行器**：智能化的测试执行和报告系统

### 核心计算算法
- **IRR计算**：牛顿法迭代求解，确保计算精度
- **现金流分配**：基于业务规则的逐期精确计算
- **数据验证**：多层次输入验证和边界检查机制
- **回本周期计算**：静态和动态两种计算方式

## 📚 计算逻辑说明

### 平层结构 - 优先还本
```
每期分配顺序：
1. 计提门槛收益 = 期初本金余额 × 门槛收益率
2. 摊还本金 = min(净现金流, 剩余本金)
3. 分配门槛收益 = min(剩余现金流, 累计门槛收益)
4. Carry分配 = 剩余现金流 × (1-管理人Carry, 管理人Carry)
```

### 平层结构 - 期间分配
```
每期分配顺序：
1. 期间收益 = min(净现金流, 期初本金余额 × 期间收益率)
2. 计提门槛收益 = 期初本金余额 × (门槛收益率 - 期间收益率)
3. 摊还本金 = min(剩余现金流, 剩余本金)
4. 分配门槛收益 = min(剩余现金流, 累计门槛收益)
5. Carry分配 = 剩余现金流 × (1-管理人Carry, 管理人Carry)
```

### 结构化 - 优先劣后
```
每期分配顺序：
1. 优先级收益 = min(净现金流, 优先级剩余本金 × 优先级收益率)
2. 优先级本金 = min(剩余现金流, 优先级剩余本金)
3. 劣后级本金 = min(剩余现金流, 劣后级剩余本金)
4. Carry分配 = 剩余现金流 × (1-管理人Carry, 管理人Carry)
```

## ❓ 常见问题

### Q: 首次使用应该运行哪个脚本？
A: 首次使用请运行 `deploy.bat`，它会自动检查和配置完整的运行环境。

### Q: 什么时候使用 start.bat？
A: 在已经成功运行过 `deploy.bat` 后，日常使用可以直接运行 `start.bat` 快速启动。

### Q: 如何验证系统功能是否正常？
A: 运行 `python run_tests.py` 进行全面的功能验证，或使用 `--api`、`--calculations`、`--charts` 参数进行专项测试。

### Q: 如果 start.bat 启动失败怎么办？
A: 如果快速启动失败，说明环境可能有问题，请重新运行 `deploy.bat` 来修复环境配置。

### Q: 系统支持的最大投资期限是多少？
A: 系统支持1-30年的投资期限，覆盖大部分实际投资场景。

### Q: 可以同时计算多个项目吗？
A: 当前版本为单项目计算模式，如需计算多个项目请分别运行。

### Q: 数据会被保存在哪里？
A: 系统不会永久保存任何数据，所有计算数据仅在会话期间存在于内存中。

### Q: 如何修改已输入的数据？
A: 可以通过步骤导航返回到相应步骤重新输入数据。

### Q: Excel导入支持哪些格式？
A: 支持.xlsx和.xls格式的Excel文件。

### Q: 测试系统有什么用？
A: 测试系统可以验证所有核心功能的正确性，确保计算结果的准确性和系统的稳定性。

## 📞 技术支持

如果在使用过程中遇到问题，请检查以下事项：

1. **Python版本**：确保Python版本为3.8或更高
2. **依赖安装**：确认所有依赖包已正确安装
3. **端口占用**：确保5000端口未被其他程序占用
4. **网络连接**：首次安装时需要网络连接下载依赖
5. **功能验证**：运行测试套件验证系统功能完整性

### 🐛 问题反馈

如果遇到Bug或有功能建议，欢迎通过以下方式反馈：

- **GitHub Issues**: [https://github.com/JMoCoder/calculation_of_fund_returns/issues](https://github.com/JMoCoder/calculation_of_fund_returns/issues)
- **项目仓库**: [https://github.com/JMoCoder/calculation_of_fund_returns](https://github.com/JMoCoder/calculation_of_fund_returns)

### 📥 获取最新版本

```bash
# 克隆项目到本地
git clone https://github.com/JMoCoder/calculation_of_fund_returns.git

# 进入项目目录
cd calculation_of_fund_returns

# 运行一键部署
deploy.bat

# 验证功能 (可选)
python run_tests.py
```

## 📄 许可证

本项目采用MIT许可证，详情请查看LICENSE文件。

## 🙏 致谢

感谢所有为本项目提供支持和建议的用户和开发者。

### 👨‍💻 开发者

- **JMoCoder** - 项目维护者
  - GitHub: [@JMoCoder](https://github.com/JMoCoder)
  - Email: jiamo.im@gmail.com

### 🤝 贡献

欢迎提交Pull Request来改进项目！请遵循以下步骤：

1. Fork本项目
2. 创建功能分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 打开Pull Request

### 🧪 贡献测试

如果您要贡献代码，请确保：
1. 所有现有测试通过：`python run_tests.py`
2. 为新功能添加相应测试
3. 测试覆盖率保持在高水平
4. 遵循项目的代码规范

## 🎯 版本特性

### v3.2.0 重要特性 (当前版本)
- ✨ **图表功能增强**: 全新的图表放大展示和PNG复制功能
- 🎯 **用户体验提升**: 图表操作更便捷，数据分享更高效
- 🔧 **技术创新**: "隐形放大展示"技术确保样式100%一致
- 📱 **全平台支持**: 桌面端和移动端完美适配
- 🛡️ **安全可靠**: 客户端处理，数据隐私有保障
- ⚡ **性能优化**: 高清图片生成，内存管理优化
- 🌐 **兼容性强**: 现代浏览器完全支持，老旧浏览器智能降级

### v3.1.0 重要特性
- ✅ **项目结构重构**: 标准化的目录结构和文件组织
- ✅ **测试系统重构**: 完整的测试框架和自动化测试
- ✅ **开发体验提升**: 更便捷的测试运行和调试工具
- ✅ **代码质量提升**: 模块化架构和规范化命名
- ✅ **向后兼容性**: 100%保持现有功能和API兼容

### 📈 性能指标
- **单次计算响应**: < 100ms
- **Excel导入处理**: < 1s (标准文件)
- **图表放大展示**: < 200ms
- **PNG复制生成**: < 800ms (3倍高清)
- **测试套件执行**: < 30s (全量测试)
- **系统启动时间**: < 5s (快速启动模式)

---

**收益分配测算系统 v3.2.0** - 专业、安全、易用的投资收益计算工具

⭐ 如果这个项目对您有帮助，请给个Star支持一下！ 