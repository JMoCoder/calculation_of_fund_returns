name: æŒç»­é›†æˆä¸éƒ¨ç½²

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: æµ‹è¯•
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.8, 3.9, 3.10, 3.11]

    steps:
    - uses: actions/checkout@v3
    
    - name: è®¾ç½®Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ä»£ç é£æ ¼æ£€æŸ¥
      run: |
        pip install flake8
        # åœæ­¢æ„å»ºå¦‚æœæœ‰Pythonè¯­æ³•é”™è¯¯æˆ–æœªå®šä¹‰çš„åç§°
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # å°†å…¶ä»–é”™è¯¯ä½œä¸ºè­¦å‘Šå¤„ç†
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        
    - name: åŸºæœ¬åŠŸèƒ½æµ‹è¯•
      run: |
        python -c "
        import sys
        sys.path.append('.')
        
        # æµ‹è¯•åº”ç”¨å¯åŠ¨
        from app import app
        app_context = app.app_context()
        app_context.push()
        
        # æµ‹è¯•åŸºæœ¬å¯¼å…¥
        from app import FundCalculator
        calc = FundCalculator()
        
        # æµ‹è¯•åŸºæœ¬è®¡ç®—åŠŸèƒ½
        params = {
            'investment_amount': 10000,
            'investment_period': 5,
            'hurdle_rate': 0.08,
            'carry_rate': 0.20
        }
        cash_flows = [0, 1000, 2000, 3000, 4000, 5000]
        
        # æµ‹è¯•ä¼˜å…ˆè¿˜æœ¬æ¨¡å¼
        result = calc.calculate_priority_repayment(params, cash_flows)
        assert 'irr' in result
        assert 'dpi' in result
        assert 'distribution_table' in result
        
        print('âœ… æ‰€æœ‰åŸºæœ¬åŠŸèƒ½æµ‹è¯•é€šè¿‡')
        "

  build:
    name: æ„å»ºæ£€æŸ¥
    needs: test
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: æµ‹è¯•éƒ¨ç½²è„šæœ¬
      run: |
        # æµ‹è¯•ä¾èµ–æ£€æŸ¥
        python -c "
        import flask
        import pandas
        import numpy
        import openpyxl
        print('âœ… æ‰€æœ‰ä¾èµ–åŒ…æ£€æŸ¥é€šè¿‡')
        "
        
    - name: éªŒè¯æ–‡ä»¶å®Œæ•´æ€§
      run: |
        python -c "
        import os
        required_files = [
            'app.py',
            'requirements.txt', 
            'deploy.bat',
            'start.bat',
            'README.md',
            'templates/index.html'
        ]
        
        for file in required_files:
            if not os.path.exists(file):
                raise FileNotFoundError(f'ç¼ºå°‘å¿…éœ€æ–‡ä»¶: {file}')
                
        print('âœ… æ‰€æœ‰å¿…éœ€æ–‡ä»¶æ£€æŸ¥é€šè¿‡')
        "

  security:
    name: å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: å®‰è£…å®‰å…¨æ£€æŸ¥å·¥å…·
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit
        
    - name: ä¾èµ–å®‰å…¨æ£€æŸ¥
      run: |
        safety check -r requirements.txt
        
    - name: ä»£ç å®‰å…¨æ£€æŸ¥
      run: |
        bandit -r . -f json -o bandit-report.json || true
        
    - name: ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: security-report
        path: bandit-report.json

  release-notes:
    name: ç”Ÿæˆå‘å¸ƒè¯´æ˜
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [test, build, security]
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
        
    - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜
      run: |
        echo "## ğŸš€ æœ€æ–°æ›´æ”¹" > RELEASE_NOTES.md
        echo "" >> RELEASE_NOTES.md
        echo "**æ„å»ºæ—¶é—´**: $(date)" >> RELEASE_NOTES.md
        echo "**æäº¤å“ˆå¸Œ**: ${{ github.sha }}" >> RELEASE_NOTES.md
        echo "" >> RELEASE_NOTES.md
        echo "### ğŸ“ æ›´æ”¹å†…å®¹" >> RELEASE_NOTES.md
        git log --oneline -10 --pretty=format:"- %s (%an)" >> RELEASE_NOTES.md
        
    - name: ä¸Šä¼ å‘å¸ƒè¯´æ˜
      uses: actions/upload-artifact@v3
      with:
        name: release-notes
        path: RELEASE_NOTES.md 